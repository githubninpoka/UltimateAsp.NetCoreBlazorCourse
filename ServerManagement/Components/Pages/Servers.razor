@page "/"
@page "/servers"
@page "/servers/back_from/{CityName}"

@inject NavigationManager NavigationManager
@rendermode InteractiveServer // this brings the entire (routable) component under the control of the server interactively.


<br />
<CityListComponent 
    @rendermode="InteractiveServer"
    @ref="cityListComponent"
    SelectedCity="@_selectedCity"
    SelectCityCallback="HandleCitySelection"></CityListComponent>

<SearchServerComponent 
    @rendermode="InteractiveServer"
    @ref="searchServerComponent"
    OnSearchPerformedCallback="HandleSearch"
    />

<ServerListComponent 
    @rendermode="InteractiveServer" 
    CityName="@_selectedCity"
    SearchString="@_searchString"
    />


@code {
    [Parameter] // this parameter is set to facilitate the multi page directive when navigating to this page
    public string CityName { get; set; }

    private CityListComponent? cityListComponent;
    private SearchServerComponent? searchServerComponent;

    private string _selectedCity = "Toronto";

    private string _searchString = "";

    private void HandleCitySelection(string selectedCity)
    {
        _selectedCity = selectedCity;
        _searchString = string.Empty;
        searchServerComponent?.ClearSearchFilter();
    }

    private void HandleSearch(string searchString)
    {
        _searchString = searchString;
        cityListComponent?.ClearCitySelection();
    }

    // @page "/servers/back_from/{CityName}"
    // this method, together with a parameter and the alternative page directive
    // allows for navigating directly to a selected city.
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            if (NavigationManager.Uri.Contains("back_from") &&
                !string.IsNullOrWhiteSpace(CityName))
            {
                _selectedCity = CityName;
                StateHasChanged();
            }
            
        }
    }

}
